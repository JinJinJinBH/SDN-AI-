## SDN实验环境的拓扑搭建说明

​	

##### 使用四台linux服务器，搭建SDN网络环境

其中一台服务器上部署OpenDaylight作为控制平面，另外三台服务器上要搭建一个数据平面。下面详细说一下数据平面拓扑的搭建。主要应用了基于vlan的路径隔离技术和私有协议。



## 数据平面搭建说明



### 数据平面拓扑需求：

​	能在三台服务器上搭建了一个形如Internet2的拓扑。



### Internet2拓扑如图：

​																				后面补图



### 拓扑相关元素：

​	数据平面使用ovs作为虚拟交换机节点，使用linux的network namespace作为虚拟主机节点，使用linux的Tap设备以及veth设备作为虚拟链路。



### 主要思路：

​	Internet2拓扑总一共有17个主要的交换节点，我们将17个节点根据地理位置分割成三部分，分别部署在三台服务器上。

​	在第一台服务器上有s6、s12、s13、s14、s15、s16六个交换节点；在第二台服务器上有s1、s2、s3、s4、s5、s7六个交换节点；在第三服务器上s8、s9、s10、s11、s17有五个交换机节点。



### 难点提出以及使用vlan路径隔离的方法：

####   难点提出：

如果一条链路的两端节点都在一台服务器内，那么这个链路就在服务器内，可以直接创建虚拟链路来代替它。但是如果一条链路两端的节点分属于不同的服务器，那么这条链路就是跨服务器的链路，<u>跨服务器的虚拟链路要创建在额外的物理链路上。一条跨服务器的虚拟链路如何创建是一个主要的问题</u>。

####   尝试方法1：将两台服务器的网卡链接上作为一条物理链路，虚拟链路创建在这条物理链路上。

* 说明：如果一条链路跨两台服务器，可以在这两台服务器的多余网卡之间创建物理链路，然后物理链路作为虚拟链路的一部分。

* 问题：一条跨服务器的链路需要额外提供一个网卡，实际上一台服务器上有3-5条跨服务器的链路，需要3-5个额外的网卡，但我们使用的服务器只有一个多余的网卡，所以尝试方法2。

####   尝试方法2：使用一个普通的以太网二层交换机，每个服务器链接到交换机上互连。

* 说明：多台服务器之间用简单的二层交换机连接，即每台服务器只需要提供一个额外的物理网卡连接到交换机。然后ovs的一个端口都桥接服务器的物理网卡上，这样多台服务器上的交换机能够互连。

* 问题：**拓扑上原来没有直接相连的交换机出现了直接连接**

  原因：各服务器的网卡通过物理交换机互连，而各个**需要跨服务器连接的交换机又直接连接到服务器网卡上**。一个服务器发出去的包，其他服务器的网卡都会受到，进而有关的OVS都会收到。最终形成一个类似树形拓扑，这个拓扑与我们需要的Internet2拓扑不同。

####   最终解决方法：基于使用vlan的路径隔离

* 基于端口的Vlan技术原理介绍

  * VLAN简介：VLAN（**虚拟**局域网）是对连接到的第二层交换机端口的网络用户的逻辑分段，不受网络用户的物理位置限制而根据用户需求进行网络分段。一个VLAN可以在一个交换机或者跨交换机实现。通过划分VLAN能够将一个局域网划分成多个广播域。VLAN通过在数据包头增加VLAN ID的方式来区分不同广播域的数据包，数据包格式如下图所示：

    ​																	图片

  * 基于交换机端口的VLAN技术：在支持VLAN的交换机上配置交换机端口和VLAN ID的对应关系，该端口在接受和发送数据包时会有如下行为：之后会对从这个端口出去的数据包加特定的VLAN ID，而且只能收到带有特定VLAN ID的数据包。交换机中，有两种类型的接口：接入端口（Access）和中继端口（Trunk），Access接口只能用来连接用户主机，只能属于一个VLAN，因此该接口只传输本VLAN的数据；而Trunk端口允许多个VLAN通过，可以接受和发送多个VLAN数据包，常用于两台中继交换机之间的端口。

    * Acess端口收报文：收到一个报文,判断是否有VLAN信息：如果没有则打上端口的PVID，并进行交换转发,如果有则直接丢弃（缺省）
    * Acess端口发报文：将报文的VLAN信息剥离，直接发送出去
    * trunk端口收报文：收到一个报文，判断是否有VLAN信息：如果没有则打上端口的PVID，并进行交换转发，如果有判断该trunk端口是否允许该 VLAN的数据进入：如果可以则转发，否则丢弃
    * trunk端口发报文：比较端口的PVID和将要发送报文的VLAN信息，如果两者相等则剥离VLAN信息，再发送，如果不相等则直接发送

  * 

  * 使用VLAN实现链路隔离：通过划分VLAN可以分离广播域，除了Trank链路会传输多个VLAN ID的数据包，其他链路上只能传输带有特定VLAN ID的数据包。因此通过对不同的链路划分VLAN ID，让他们只能传输特定VLAN ID的数据包，做到隔离链路的功能。因此，在跨服务器的Internet2拓扑中，对于每条跨服务器链路可以设置一个VLAN ID。

* ##### ovs-vlan技术介绍：

  * 使用OVS实现VLAN组网：在OVS中，VLAN的概念和普通交换机一样，不同的是，在OVS中可以通过流表进行VLAN值的修改，这就使得VLAN在OVS中的应用更加灵活。本实验主要使用传统方式设置vlan tag，和普通交换机工作原理相同，通过access进行设置vlan tag，通过trunk进行转发vlan报文来完成vlan组网。

  * ovs配置vlan命令

    以下图场景为例，4台PC设备分别接入不同的SDN交换机，通过vlan组成大二层网络。其中交换机中的eth1和eth2两个端口用于接入PC，OVS通过VLAN组网把PC1和PC3划分为VLAN 100，把PC2和PC4换分为VLAN 200，从而实现二层的网络隔离。其中PC1-PC3上的数据包 不会被发送到PC2-PC4链路上，即PC1到PC3的链路与PC2到PC4的链路实现了隔离。

    设置ovs端口为trunk类型并配置可以转发的vlan：

    ```
    	ovs-vsctl set Port eth0 trunks=100,200
    ```

    设置eth1的接口为access类型并配置tag：

    ```
    	ovs-vsctl set port eth1 tag=100
    	ovs-vsctl set Port eth2 tag=200
    ```

* ##### 方法说明：

  ​	1）在每个服务器内再创建一个使用VLAN的ovs（以下简称vlan-ovs）。

  ​	2）这个vlan-ovs绑定到连接各个需要跨服务器的OVS和服务器的物理网卡。

  ​	3）vlan-ovs与服务器物理网卡连接的端口设置为trunk模式

  ​	4）vlan-ovs为需要跨服务器互连的每对交换机提供一个VLAN ID

  

  **最终形成的拓扑样貌为：每个服务器内的虚拟链路连接到一个vlan-ovs交换机，各个服务器的vlan-ovs交换机借助外部网络连通，外部网络就是使用二层以太网交换机的物理网络。**

  这样有直接连接的OvS可以正常的跨国Vlan，没有直接连接的OvS会因为Vlan标签不符无法进行LLDP报文的交换。

  由于Vlan-OvS放置在服务器中OvS的“外面”，所有的Vlan标签不会对正常通信产生影响，实现了“透明性”。

* ##### 转发流程：

  每条虚拟链路配一个vlan标签，用不同vlan标签区分不同的虚拟链路。vlan-ovs收到虚拟链路一端的数据包后，打上正确的标签，通过物理网络转发到其他服务器上的vlan-ovs，它们收到后，根据数据包头的标签将流量从特定端口转发，即转发到到同一虚拟链路的另一端。

* ##### 小结：

  通过使用基于vlan的路径隔离技术，我们在三台服务器之间实现了不同虚拟链路的隔离。虽然跨服务器的多条虚拟链路共享同一个物理网络，但是这些链路上的流量在物理网络两端会通过vlan-ovs隔离，达到逻辑上的多条链路，从而能够构建各种想要的拓扑。

### 最终数据平面的详细拓扑如图：

​																			后面补图



### 私有协议：

​	我们实际物理网络中使用的交换机是一台普通的以太网二层交换机，没有vlan功能。即这个交换机是基于mac地址学习的方法转发流量的。而使用这样的交换机是无法将多个服务器之间连通的，下面说明存在的问题。

##### 使用普通二层交换机带来的mac地址学习两次的问题：

​	假设服务器1和服务器2之间有两条不同的虚拟链路分别是vlan100和vlan200。这两条虚拟链路建立在物理网络（二层交换机）之上。那么当一个数据包经过虚拟链路vlan100从服务器1发给服务器2时，交换机记录一下mac地址，当数据包经过虚拟链路vlan200从服务器2又发给服务器1时，交换机又记录了一次mac地址。

​	这种mac地址与端口映射的不断变化会导致交换机失效。导致转发出问题。

##### 使用私有协议解决：

​	说明：在实验设备的限制下，我们没有带vlan功能的交换机作为物理网络。所以我们需要使用私有协议的范式使二层交换机工作的像一台hub设备。即这个交换机会从一个端口收到一个广播包，然后从其他端口转发。这样服务器之间就通过一个hub设备互连。

​	方法：在每个服务器内，vlan-ovs的出端口和网卡之间插入一个**增/删广播头模块**，该模块功能是在出入的数据包前增加一层广播协议，即往外发的数据包增加一层广播头，往内发的数据包去掉一层广播头。通过这样的方式让物理的二层交换机像hub一样工作，从而连通多台服务器。	







ps：之后会补充图片，还有创建vlan-ovs的代码